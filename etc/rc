#
# rc - system startup script
#

# System environment
HOME=/; export HOME
PATH=/bin:/sbin:/usr/sbin:/usr/ucb:/usr/bin; export PATH

# Show a startup banner
echo ''							>/dev/console 2>&1
echo ''							>/dev/console 2>&1
echo 'Starting the system.'				>/dev/console 2>&1
echo ''							>/dev/console 2>&1
date							>/dev/console 2>&1
echo ''							>/dev/console 2>&1

# Load configuration
echo 'Loading configuration.'				>/dev/console 2>&1
. /etc/rc.default
. /etc/rc.conf

# Determine boot mode
bootmode="$1"

# Handle power failure
if [ "$2" = powerfail ]; then
	echo ''						>/dev/console 2>&1
	echo 'WARNING - REBOOT AFTER POWER FAILURE'	>/dev/console 2>&1
	echo ''						>/dev/console 2>&1
	fsck_always=yes
	fsck_force=yes
fi

# Check and mount file systems
. /etc/rc.filesys

# Perform cleanup
. /etc/rc.cleanup

# Update the device database
echo 'Updating device database.'			>/dev/console 2>&1
dev_mkdb

# Update the process database
echo 'Updating process database.'			>/dev/console 2>&1
ps -U							>/dev/console 2>&1

# Initialize disk quotas
echo 'Checking quotas.'					>/dev/console 2>&1
quotacheck -a						>/dev/console 2>&1
quotaon -a

# Initialize networking
. /etc/rc.network

# Start syslogd when networking is available
if [ "${inet_enable}" = yes -a "${syslogd_enable}" = yes ]; then
	echo 'Starting syslogd.'			>/dev/console 2>&1
	rm -f /dev/log
	syslogd ${syslogd_flags}
fi

# Check for core dumps if /etc/crash exists
if [ -d /etc/crash ]; then
	echo 'Checking for core dumps.'			>/dev/console 2>&1
	savecore /etc/crash				>/dev/console 2>&1
fi

# Check editor recovery
echo 'Checking for editor recovery.'			>/dev/console 2>&1
(cd /tmp; /usr/sbin/expreserve -a)

# Warn about ongoing vipw sessions
if [ -s /etc/ptmp ]; then
	echo ''						>/dev/console 2>&1
	echo 'WARNING - PASSWD FILE NEEDS RECOVERY'	>/dev/console 2>&1
	echo ''						>/dev/console 2>&1
fi

# Allow logins
echo 'Logins are now allowed.'				>/dev/console 2>&1
rm -f /etc/nologin

# Start daemons
. /etc/rc.daemons

# Run local script
/etc/rc.local

# Finished
echo ''							>/dev/console 2>&1
date							>/dev/console 2>&1
echo ''							>/dev/console 2>&1
echo 'System startup has finished.'			>/dev/console 2>&1

# Exit with success
exit 0
